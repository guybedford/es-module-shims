<!doctype html>
<script type="importmap">
{
  "imports": {
    "app": "data:text/javascript,window.native=true;window.shared=0;",
    "shared": "data:text/javascript,window.shared++;"
  }
}
</script>
<script async src="https://unpkg.com/construct-style-sheets-polyfill@3.0.0/dist/adoptedStyleSheets.js"></script>
<script>
  window.esmsInitOptions = { polyfillEnable: ['css-modules'] };
</script>

<script type="module">
// Dynamic map injections only supported in this timing profile by the polyfill
document.head.appendChild(Object.assign(document.createElement('script'), {
  type: 'importmap',
  innerHTML: '{ "imports": { "app": "data:text/javascript,window.polyfill=true;window.shared=0;" } }'
}));
</script>

<script type="module">
import 'app';
import 'shared';
import x from '/test/fixtures/css-assertion.js';

if (window.native && window.polyfill)
  throw new Error('Expected native or polyfill exec, not both');
if (window.native)
  console.log('NATIVE EXEC');
if (window.polyfill)
  console.log('POLYFILL EXEC');
if (window.shared !== 1)
  throw new Error('Expected shared execution once');

fetch('/done');
</script>

<script type="module" src="/src/es-module-shims.js" async></script>
