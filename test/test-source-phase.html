<!doctype html>
<title>Source Phase WPT HTML Test</title>
<script type="module" src="../src/es-module-shims.js"></script>
<script>
  window.esmsInitOptions = {
    polyfillEnable: ['wasm-modules', 'source-phase']
  };
  window.assert_true = (predicate) => {
    if (!predicate) {
      fetch(`/error`);
      throw new Error('Not true');
    }
  };
  window.assert_equals = (a, b) => {
    if (a !== b) {
      fetch(`/error`);
      throw new Error('Not equal');
    }
  };
  window.assert_array_equals = (a, b) => {
    console.log(a, b);
    for (let i = 0; i < Math.max(a.length, b.length); i++) {
      if (a[i] !== b[i]) {
        fetch(`/error`);
        throw new Error('Not array equal');
      }
    }
  };
</script>
<!-- from wasm/webapi/esm-integration/source-phase.tentative.html -->
<script type=module>
  import source exportedNamesSource from "./resources/exported-names.wasm";
  
  assert_true(exportedNamesSource instanceof WebAssembly.Module);
  const AbstractModuleSource = Object.getPrototypeOf(WebAssembly.Module);
  assert_equals(AbstractModuleSource.name, "AbstractModuleSource");
  assert_true(exportedNamesSource instanceof AbstractModuleSource);
  
  assert_array_equals(WebAssembly.Module.exports(exportedNamesSource).map(({ name }) => name).sort(),
                      ["func", "glob", "mem", "tab"]);
  
  const wasmImportFromWasmSource = await import.source("./resources/wasm-import-from-wasm.wasm");
  
  assert_true(wasmImportFromWasmSource instanceof WebAssembly.Module);
  
  let logged = false;
  const instance = await WebAssembly.instantiate(wasmImportFromWasmSource, {
    "./wasm-export-to-wasm.wasm": {
      log () {
        logged = true;
      }
    }
  });
  instance.exports.logExec();
  assert_true(logged);

  fetch('/done');
</script>
<script>
  (async () => {
    try {
      await import('./fixtures/tla.js');
    } catch (e) {
      // Does not support TLA -> skip test
      await fetch('/TLA UNSUPPORTED');
      fetch('/done');
    }
  })();
</script>
<body></body>
