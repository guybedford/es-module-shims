<!doctype html>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'nonce-asdf' 'unsafe-eval' unpkg.com; connect-src 'self' blob:; style-src-elem 'self' blob:; require-trusted-types-for 'script'; trusted-types default es-module-shims;" />
<link rel="stylesheet" type="text/css" href="../node_modules/mocha/mocha.css"/>
<script src="../node_modules/mocha/mocha.js"></script>
<script type="esms-options" nonce="asdf">{}</script>
<script src="https://unpkg.com/construct-style-sheets-polyfill@3.1.0/dist/adoptedStyleSheets.js" nonce="asdf"></script>
<script type="importmap" nonce="asdf">
{
  "imports": {
    "once": "/test/fixtures/once.js",
    "test": "/test/fixtures/es-modules/es6-file.js",
    "test/": "/test/fixtures/",
    "global1": "/test/fixtures/es-modules/global1.js",
    "/test/fixtures/es-modules/dynamic.js": "/test/fixtures/es-modules/dynamic-url-map.js",
    "data": "data:text/javascript,",
    "a": "/test/fixtures/instance-case-a.js",
    "b": "/test/fixtures/instance-case-b.js"
  }
}
</script>
<script type="importmap" nonce="asdf">
{
  "imports": {
    "global1": "data:text/javascript,throw new Error('Polyfill should not support multiple import maps');"
  }
}
</script>

<script nonce="asdf">
  window.noEval = true;
  window.esmsInitOptions = {
    polyfillEnable: ['wasm-modules', 'import-defer']
  };
  window.domLoad = 0;
  document.addEventListener('DOMContentLoaded', () => {
    window.domLoad++;
  });
</script>

<script nonce="asdf">
  window.import2 = import('data');
</script>

<script type="module" nonce="asdf">
  import 'once';
</script>

<script type="module" src="../src/es-module-shims.js" nonce="asdf"></script>

<script type="module" noshim nonce="asdf">
  import { runMochaTests } from "./runMochaTests.js";
  // Create a Trusted Types policy to allow expected script and HTML creations within the polyfill tests.
  // Do not use this pattern in production code
  if (typeof window.trustedTypes !== 'undefined' || typeof window.TrustedTypes !== 'undefined') {
    try {
      (window.trustedTypes || window.TrustedTypes).createPolicy("default", {
        // Assume mocha html is trusted for test purposes
        // Ensure any new es-module-shims code that updates html fail these tests before adding maybeTrustedInnerHTML
        createHTML: html => html,
        // Allow the two expected dynamic import scripts within the polyfill tests with eval
        createScript: script => {
          if (script === "import('./fixtures/tla.js');" || script === "import('./fixtures/json.json', { with: { type: 'json' } })") {
            return script;
          }
          throw new Error('Unexpected script creation: ' + script);
        }
      });
    } catch { }
  }
  runMochaTests('polyfill');
</script>

<div id="mocha"></div>
